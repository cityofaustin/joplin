{% extends "wagtailadmin/pages/edit.html" %}

{% load wagtailadmin_tags %}
{% load joplin_tags %}
{% load i18n %}
{% load l10n %}
{% block titletag %}{% blocktrans with title=page.get_admin_display_title page_type=content_type.model_class.get_verbose_name %}Editing {{ page_type }}: {{ title }}{% endblocktrans %}{% endblock %}
{% block bodyclass %}page-editor {% if page.live %}page-is-live{% endif %} model-{{ content_type.model }} {% if page.locked %}page-locked{% endif %}{% endblock %}

{% block content %}
    {% get_preview_url revision=page.get_latest_revision as preview_url %}
    <script type="text/javascript">
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Fallback: Copying text command was ' + msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }

        function copyTextToClipboard(text) {
            if (!navigator.clipboard) {
                fallbackCopyTextToClipboard(text);
                return;
            }
            navigator.clipboard.writeText(text).then(function() {
                console.log('Async: Copying to clipboard was successful!');
            }, function(err) {
                console.error('Async: Could not copy text: ', err);
            });
        }

        $(function() {
            var editform = $('#page-edit-form');
            var previewbutton = $('#page-preview-button');
            var sharebutton = $('#page-share-preview-button');
            var urlcopied = $('#page-share-url-copied');

            if(localStorage.previewing === 'true') {
                window.open("{{preview_url}}", '_blank');
                localStorage.previewing = false;
            }

            if(localStorage.sharingpreview === 'true') {
                // TODO: Don't just alert with the preview URL
                copyTextToClipboard("{{preview_url}}");
                urlcopied.removeClass("hidden");
                urlcopied.fadeOut(5000);
                localStorage.sharingpreview = false;
            }

            previewbutton.click(function() {
                localStorage.previewing = true;
            });

            sharebutton.click(function() {
                localStorage.sharingpreview = true;
            });
        })
    </script>

    <style type="text/css">
        #page-share-url-copied {
            background: white;
            position: fixed;
            border: solid black;
            padding: 2px;
            margin: 5px;
        }
    </style>


    <div class="header secondary">
        <div>
            <h1 class="edit_page_header">
                Edit
                <span class="page_type">{{ content_type.model_class.get_verbose_name }}</span>
                <span class="page_title">{{ page.get_admin_display_title }}</span>
            </h1>
        </div>

        <div class="actions">
            <div>
                <div>
                    Last modified <span class="time">{{ page.get_latest_revision.created_at }}</span>
                </div>
                <div>See <a href="{% url 'wagtailadmin_pages:revisions_index' page.id %}" class="underlined">all revisions</a></div>
            </div>
            <div>
                <button id="page-share-preview-button" type="submit" form="page-edit-form" class="button action-save button-longrunning icon icon-view {% if is_revision %}warning{% endif %}" data-clicked-text="{% trans 'Saving…' %}" {% if page.locked %}disabled {% endif %}>
                  <span class="icon icon-spinner"></span>
                  <em>
                    {% if page.locked %}
                      {% trans 'Page locked' %}
                    {% else %}
                      {% if is_revision %}
                        {% trans 'Replace current draft' %}
                      {% else %}
                        {% trans 'Share' %}
                      {% endif %}
                    {% endif %}
                  </em>
                </button>
                <div id="page-share-url-copied" class="hidden">
                  Preview URL copied to clipboard.
                </div>
            </div>
            <div>
                <button id="page-preview-button" type="submit" form="page-edit-form"
                  class="button action-save button-longrunning {% if is_revision %}warning{% endif %}"
                  data-clicked-text="{% trans 'Saving…' %}"
                  {% if page.locked %}disabled {% endif %}
                >
                  <span class="icon icon-spinner"></span>
                  <em>
                    {% if page.locked %}
                      {% trans 'Page locked' %}
                    {% else %}
                      {% if is_revision %}
                        {% trans 'Replace current draft' %}
                      {% else %}
                        {% trans 'Preview' %}
                      {% endif %}
                    {% endif %}
                  </em>
                </button>
            </div>
            <div>
                <button type="submit" form="page-edit-form"
                  class="button action-save button-longrunning {% if is_revision %}warning{% endif %}"
                  data-clicked-text="{% trans 'Saving…' %}"
                  {% if page.locked %}disabled {% endif %}
                >
                  <span class="icon icon-spinner"></span>
                  <em>
                    {% if page.locked %}
                      {% trans 'Page locked' %}
                    {% else %}
                      {% if is_revision %}
                        {% trans 'Replace current draft' %}
                      {% else %}
                        {% trans 'Save draft' %}
                      {% endif %}
                    {% endif %}
                  </em>
                </button>
            </div>
            <div>
                <button class="button button-longrunning icon icon-doc-empty"
                  type="submit" form="page-edit-form"
                  data-clicked-text="{% trans 'Publishing…' %}"
                  name="action-publish" value="action-publish"
                >
                  Publish
                </button>
            </div>
        </div>
    </div>

    <div class="flex-container">
      <div class="edit-page-form-container">
        {{ block.super }}
      </div>
      <div class="sidebar-container">
        <div class="fixed-content">
          <div class="thumbnail-container">
            <div class="thumbnail">
              <iframe frameborder="0" onload="this.style.opacity = 1" src="https://cityofaustin.github.io/digital-services-style-guide/introduction/"></iframe>
            </div>
          </div>
          <ul class="tab-nav">
            <li><a>Preview</a></li>
            <li class="active"><a>Style Guide</a></li>
          </ul>
        </div>
      </div>
    </div>
{% endblock %}
